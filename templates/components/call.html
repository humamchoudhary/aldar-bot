<div
  id="callarea"
  class="{% if call %}w-2/3 flex {%else%} hidden{% endif %} h-[93vh] border-l border-[var(--border-color)] transition-all duration-300"
>
  {% if call %}
  <div class="flex flex-row w-full h-full">
    <!-- Transcription Section (Middle) -->
    <div
      class="flex flex-col w-screen md:w-[500px] 2xl:w-[750px] h-full overflow-y-scroll call-detail-scroll p-6 relative"
    >
      <div class="flex flex-col gap-4 mb-20">
        <!-- Audio Player -->
        <div
          class="sticky top-0 bg-[var(--main-bg-color)] z-10 pb-4 border-b border-[var(--border-color)]"
        >
          <h3 class="text-xl font-bold mb-3">Call Recording</h3>
          <audio controls class="w-full">
            <source
              src="/admin/call/{{ call.call_id }}/audio"
              type="audio/wav"
            />
            Your browser does not support the audio element.
          </audio>
        </div>

        <!-- Transcription -->
        <div class="flex flex-col gap-6">
          <h3 class="text-xl font-bold mb-2">Transcription</h3>
          {% if call.transcription and call.transcription|length > 0 %} {% for
          message in call.transcription %}
          <div
            class="message flex w-full items-center w-full relative border border-[var(--border-color)] rounded-[5px] p-[16px] {% if message.speaker != 'user' %}bg-[var(--sec-bg-color)]{% endif %}"
          >
            <div
              class="absolute -top-3 left-[30px] px-[15px] py-[4px] rounded-full {% if message.speaker.lower() == 'user' %}bg-[var(--white)] text-[var(--bg-color)]{% else %}bg-[#0095FF]{% endif %}"
            >
              <p class="text-[11px] uppercase">{{ message.speaker }}</p>
            </div>
            <div
              class="md-content"
              style="
          padding: 10px 10px;
          border-radius: 5px;
          font-size: 12px;
          font-weight: 400;
          font-family: var(--goglobe-heading-font-family);
          background-color: {% if message.speaker == 'user' %}#cfcbe0{% else %}var(--goglobe-some-r-bg-color){% endif %};
          color: var(--goglobe-heading-color);
          border: 0.5px solid var(--goglobe-border-color);
          width: 85%;
          word-wrap: break-word;
          overflow-wrap: break-word;
          text-wrap:auto;
        "
            >
              {{ message.transcription }}
            </div>
          </div>
          {% endfor %} {% else %}
          <div
            class="flex items-center justify-center py-12 text-[var(--sec-text)] opacity-70"
          >
            <p>No transcription available yet</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Fixed Enter Call Button (Only if call is ongoing or in_progress) -->
      {% if call.status in ['ongoing', 'in_progress'] %}
      <div
        class="fixed bottom-6 left-[calc(33.33%+24px)] right-[calc(33.33%+24px)] z-20"
      >
        <button
          class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition-all duration-200 flex items-center justify-center gap-2"
          onclick="initiateCall('{{  call.userdata.name }}-{{ call.userdata.qid}}-{{call.userdata.From}}')"
        >
          <i data-lucide="phone-call" class="size-5"></i>
          <span>Enter Call</span>
        </button>
      </div>
      {% endif %}
    </div>

    <!-- User Data Section (Right) -->
    <div
      class="flex flex-col h-full border-l border-[var(--border-color)] p-6 overflow-y-auto call-detail-scroll"
    >
      <h3 class="text-xl font-bold mb-4">Call Information</h3>

      <div class="flex flex-col gap-4">
        <!-- Status Badge -->
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70">Status</span>
          {% if call.status == 'ongoing' %}
          <div class="px-4 py-2 bg-green-500/20 rounded-lg text-center">
            <p class="text-sm font-bold text-green-500">● Ongoing</p>
          </div>
          {% elif call.status == 'in_progress' %}
          <div class="px-4 py-2 bg-yellow-500/20 rounded-lg text-center">
            <p class="text-sm font-bold text-yellow-500">◐ In Progress</p>
          </div>
          {% elif call.status == 'ended' %}
          <div class="px-4 py-2 bg-blue-500/20 rounded-lg text-center">
            <p class="text-sm font-bold text-blue-500">✓ Ended</p>
          </div>
          {% endif %}
        </div>

        <!-- Caller Name -->
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70"
            >Caller Name</span
          >
          <p class="text-base font-semibold">
            {{ call.userdata.name if call.userdata.name else 'Unknown Caller' }}
          </p>
        </div>

        <!-- Phone Number -->
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70"
            >Phone Number</span
          >
          <p class="text-base font-semibold">
            {{ call.userdata.From if call.userdata.From else 'No number' }}
          </p>
        </div>

        <!-- Call ID -->
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70">Call ID</span>
          <p class="text-base font-mono text-sm break-all">
            {{ call.call_id }}
          </p>
        </div>

        <!-- QID (if available) -->
        {% if call.userdata.qid %}
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70">QID</span>
          <p class="text-base font-semibold">{{ call.userdata.qid }}</p>
        </div>
        {% endif %}

        <!-- Started At -->
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70"
            >Started At</span
          >
          <p class="text-base">{{ call.started_at.strftime('%d %B %Y') }}</p>
          <p class="text-sm text-[var(--sec-text)]">
            {{ call.started_at.strftime('%H:%M:%S') }}
          </p>
        </div>

        <!-- Ended At (if available) -->
        {% if call.ended_at %}
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70"
            >Ended At</span
          >
          <p class="text-base">{{ call.ended_at.strftime('%d %B %Y') }}</p>
          <p class="text-sm text-[var(--sec-text)]">
            {{ call.ended_at.strftime('%H:%M:%S') }}
          </p>
        </div>

        <!-- Duration -->
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70"
            >Duration</span
          >
          <p class="text-base font-semibold">
            {{ ((call.ended_at - call.started_at).total_seconds() / 60) |
            round(1) }} minutes
          </p>
        </div>
        {% endif %}

        <!-- Message Count -->
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70"
            >Messages</span
          >
          <p class="text-base font-semibold">
            {{ call.transcription|length }} message{{ 's' if
            call.transcription|length != 1 else '' }}
          </p>
        </div>

        <!-- Additional Custom Parameters -->
        {% if call.userdata %} {% for key, value in call.userdata.items() %} {%
        if key not in ['From', 'name', 'qid'] and value %}
        <div class="flex flex-col gap-2">
          <span class="text-sm text-[var(--sec-text)] opacity-70"
            >{{ key|title }}</span
          >
          <p class="text-base">{{ value }}</p>
        </div>
        {% endif %} {% endfor %} {% endif %}
      </div>

      <!-- Action Buttons -->
      <div
        class="flex flex-col gap-3 mt-6 pt-6 border-t border-[var(--border-color)]"
      >
        <button
          hx-post="/admin/call/{{ call.call_id }}/delete"
          hx-confirm="Are you sure you want to delete this call?"
          hx-on::after-request="handleCallDelete('{{ call.call_id }}')"
          class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg transition-all duration-200"
        >
          <i data-lucide="trash-2" class="size-4"></i>
          <span class="font-semibold">Delete Call</span>
        </button>
      </div>
    </div>
  </div>
  {% endif %}
</div>
