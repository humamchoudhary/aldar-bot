{% extends 'user/base-min.html' %} {% block content %}
<style>


#send-btn{
transition:all 0.3s ease-in-out 0.1s;
}
#send-btn:hover{
opacity:0.7;

}

/* Add to your existing CSS */
#audio-feedback {
    transition: all 0.3s ease;
}

#recording-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
}

#audio-visualizer {
    display: flex;
    align-items: end;
    gap: 2px;
    height: 20px;
}

/* Code Block Styling */
.md-content pre {
    position: relative;
    background-color: #1e1e1e;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
    overflow-x: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.md-content pre code {
    display: block;
    color: #d4d4d4;
    font-family: 'Courier New', Courier, monospace;
    font-size: 14px;
    line-height: 1.6;
    #0e1024-space: pre;
    background: none;
    padding: 0;
    border: none;
}

/* Inline code styling */
.md-content code {
    background-color: rgba(255, 255, 255, 0.1);
    color: #e06c75;
    border-radius: 4px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.9em;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.md-content pre code {
    color: #d4d4d4;
    background: none;
    padding: 0;
    border: none;
}

/* Copy button styling */
.code-copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 6px 12px;
    background-color: rgba(255, 255, 255, 0.1);
    color: #0e1024;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    backdrop-filter: blur(10px);
}

.code-copy-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.code-copy-btn:active {
    transform: scale(0.95);
}

.code-copy-btn.copied {
    background-color: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.4);
    color: #22c55e;
}

/* Icon styling */
.copy-icon {
    width: 14px;
    height: 14px;
}

/* Syntax highlighting (optional - basic colors) */
.md-content pre code .keyword { color: #c678dd; }
.md-content pre code .string { color: #98c379; }
.md-content pre code .comment { color: #5c6370; font-style: italic; }
.md-content pre code .number { color: #d19a66; }
.md-content pre code .function { color: #61afef; }



</style>


<!-- AI Chat Bot Page -->
<div style="display: flex; position: relative; margin-bottom:10px">
  <div style="min-height: 100%; padding-left: 0.5rem; padding-right: 0.5rem; width: 100%; display: flex; flex-direction: column; position: relative; z-index: 3;">
    <!-- Chat Messages -->
    {% if chat %}
        <div id="messageArea" style="display: flex; position: relative;min-height:300px ; height:100%; flex-direction:column; gap:25px; overflow-y: auto; ">
          {% for message in chat.messages %} 
          {% include 'user/fragments/chat_message.html' %}
          {% endfor %}
        </div>
    {% endif %} 
    
    {% if chat %}
    <div style="margin-top: auto; position: sticky; bottom: -10px; padding: 10px 0px 0px 0px; background-color: var(--goglobe-site-bg-color);">
      <div style="display: flex; flex-direction: row; width: 100%; gap: 10px">
        <div style="width: 100%; height: fit-content; position: relative">
<textarea
  rows="1"
  name="message"
  placeholder="Send a message..."
  id="fn__chat_textarea"
  style="
    min-height: 0px;
    margin-bottom: 0px;
    border-radius: 6px;
    box-sizing: border-box;
    background-color: transparent;
    outline: none;
    display: block;
    width: 100%;
    padding: 8px 10px 8px;
    padding-right: 72px;
    font-size: 12px;
    font-weight: 400;
    line-height: 22px;
    max-height: 170px;
    font-family: var(--goglobe-heading-font-family);
    resize: none;
    overflow-y: hidden;
    color: var(--goglobe-heading-color);

 transition: border-color 0.2s ease;  "
  onkeyup="handleKeyPress(event); checkInputValue();"
></textarea>

<style>
#fn__chat_textarea{


    border: 2px solid var(--goglobe-border-color);
}
  #fn__chat_textarea:focus {
    border-color: var(--goglobe-main-color); /* ðŸ‘ˆ highlight border on focus */
  }
</style>


          <button id="send-btn" style="position: absolute; width: 40px; height: 30px; bottom: 6px; right: 8px; padding: 0; margin: 0; border-radius: 5px; outline: none; cursor: pointer; border: none; background-color: var(--goglobe-main-color); display: flex; align-items: center; justify-content: center; color: #0e1024; transition: all 0.3s ease;" onclick="sendMessage()">
            <img
              src="{{ settings['backend_url'] }}{{ url_for('static', filename='svg/enter.svg') }}"
              alt=""
              style="color: #0e1024; width: 12px; height: 12px; filter: invert(1);"
            />
          </button>
        </div>


        <div
          id="enable-mic"
          style="
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
            border-radius: 9999px;
            border: 0.5px solid var(--goglobe-border-color);
            transition: all 200ms;
            position: relative;
            width: 40px;
            height:30px;
            cursor: pointer;
          "
          title="Request Assistance"
          onclick="enableMic()"
          onmouseover="this.style.backgroundColor='var(--goglobe-main-color)'; this.style.borderColor='var(--goglobe-hover-color)';"
          onmouseout="this.style.backgroundColor=''; this.style.borderColor='var(--goglobe-border-color)';"
        >
<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic-icon lucide-mic"><path d="M12 19v3"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><rect x="9" y="2" width="6" height="13" rx="3"/></svg>
        </div>

        <div
          id="ping-admin-btn"
          style="
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
            border-radius: 9999px;
            border: 0.5px solid var(--goglobe-border-color);
            transition: all 200ms;
            position: relative;
            width: 30px;
            height:30px;
            cursor: pointer;
          "
          title="Request Assistance"
          onclick="pingAdmin()"
          onmouseover="this.style.backgroundColor='var(--goglobe-main-color)'; this.style.borderColor='var(--goglobe-hover-color)';"
          onmouseout="this.style.backgroundColor=''; this.style.borderColor='var(--goglobe-border-color)';"
        >
          <img
            style="border-radius: 9999px; min-width: 35px; "
            src="{{ settings['backend_url'] }}{{ url_for('static', filename='img/ana.jpg') }}"
          />
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>

// Add these variables at the top of your script section
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let audioContext = null;
let analyser = null;
let microphone = null;
let javascriptNode = null;

// Enable/disable mic function
function enableMic() {

    console.log("Enable Mic")

    const micButton = document.getElementById('enable-mic');
    const textarea = document.getElementById('fn__chat_textarea');
    const sendBtn = document.getElementById('send-btn');
    
    if (!isRecording) {
        // Start recording
        startRecording(micButton, textarea, sendBtn);
    } else {
        // Stop recording
        stopRecording(micButton, textarea, sendBtn);
    }
}

// Start recording function
function startRecording(micButton, textarea, sendBtn) {
    // Change icon to close icon
    micButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square">
            <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
        </svg>
    `;
    
    // Hide textarea and show audio feedback
    textarea.style.display = 'none';
    createAudioFeedback();
    
    // Disable send button
    sendBtn.style.cursor = 'not-allowed';
    sendBtn.style.opacity = '0.5';
    
    // Start recording process
    startAudioRecording();
}

// Stop recording function
function stopRecording(micButton, textarea, sendBtn) {
    // Change icon back to mic
    micButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic">
            <path d="M12 19v3"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><rect x="9" y="2" width="6" height="13" rx="3"/>
        </svg>
    `;
    
    // Remove audio feedback and show textarea
    removeAudioFeedback();
    textarea.style.display = 'block';
    
    // Re-enable send button if textarea has content
    if (textarea.value.trim() !== '') {
        sendBtn.style.cursor = 'pointer';
        sendBtn.style.opacity = '1';
    }
    
    // Stop recording and send audio
    stopAudioRecording();
}

// Create audio feedback visualization
function createAudioFeedback() {
    const textareaContainer = document.querySelector('div[style*="width: 100%; height: fit-content; position: relative"]');
    
    // Create audio feedback element
    const audioFeedback = document.createElement('div');
    audioFeedback.id = 'audio-feedback';
    audioFeedback.style.cssText = `
        display: flex;
        align-items: center;
        padding: 8px 20px;
        border: 2px solid var(--goglobe-main-color);
        border-radius: 6px;
        background-color: rgba(207, 203, 224, 0.2);
        color: var(--goglobe-heading-color);
        font-size: 12px;
        font-family: var(--goglobe-heading-font-family);
        margin-bottom: 0px;
    `;
    
    // Create recording indicator
    const recordingIndicator = document.createElement('div');
    recordingIndicator.id = 'recording-indicator';
    recordingIndicator.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 4px;">
                <span style="display: inline-block; width: 8px; height: 8px; background-color: #ff3b30; border-radius: 50%; animation: pulse 1.5s infinite;"></span>
                <span>Recording...</span>
            </div>
            <div id="audio-visualizer" style="display: flex; align-items: center; gap: 2px; height: 20px;"></div>
        </div>
    `;
    
    audioFeedback.appendChild(recordingIndicator);
    textareaContainer.insertBefore(audioFeedback, textareaContainer.firstChild);
    
    // Add pulse animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}

// Remove audio feedback
function removeAudioFeedback() {
    const audioFeedback = document.getElementById('audio-feedback');
    if (audioFeedback) {
        audioFeedback.remove();
    }
}

// Start audio recording with visualization
function startAudioRecording() {
    audioChunks = [];
    
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            // Set up audio context for visualization
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
            
            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;
            
            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);
            
            // Set up audio visualization
            setupAudioVisualization();
            
            // Set up media recorder
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                // Clean up audio context
                if (javascriptNode) javascriptNode.disconnect();
                if (analyser) analyser.disconnect();
                if (microphone) microphone.disconnect();
                if (audioContext) audioContext.close();
                
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
                
                // Send audio to server
                sendAudioToServer();
            };
            
            // Start recording
            mediaRecorder.start();
            isRecording = true;
        })
        .catch(error => {
            console.error('Error accessing microphone:', error);
            alert('Unable to access microphone. Please check your permissions.');
            resetUI();
        });
}

// Set up audio visualization
function setupAudioVisualization() {
    const visualizer = document.getElementById('audio-visualizer');
    visualizer.innerHTML = '';
    
    // Create bars for visualization
    for (let i = 0; i < 10; i++) {
        const bar = document.createElement('div');
        bar.style.cssText = `
            width: 3px;
            background-color: var(--goglobe-main-color);
            border-radius: 5px;
            transition: height 0.1s ease;
        `;
        visualizer.appendChild(bar);
    }
    
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    javascriptNode.onaudioprocess = () => {
        analyser.getByteFrequencyData(dataArray);
        
        // Calculate average volume
        let sum = 0;
        for (let i = 0; i < bufferLength; i++) {
            sum += dataArray[i];
        }
        const average = sum / bufferLength;
        
        // Update visualization bars
        const bars = visualizer.children;
        for (let i = 0; i < bars.length; i++) {
            // Calculate height based on volume with some variation
            const height = Math.max(Math.min(20, (average / 128) * 20 * (1 + Math.sin(i) * 0.3))*5,4);
            bars[i].style.height = `${height}px`;
        }
    };
}

// Stop audio recording
function stopAudioRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
    }
}

// Send audio to server
function sendAudioToServer() {


    if (audioChunks.length === 0) {
        console.error('No audio data to send');
        return;
    }
    
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.wav');
    
    fetch('{{settings["backend_url"]}}/min/chat/{{chat.chat_id}}/send_audio', {
        method: 'POST',
        body: formData,
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        scrollToBottom();
    })
    .catch(error => {
        console.error('Error sending audio:', error);
        alert('Failed to send audio message. Please try again.');
    });
}

// Reset UI in case of errors
function resetUI() {
    const micButton = document.getElementById('enable-mic');
    const textarea = document.getElementById('fn__chat_textarea');
    const sendBtn = document.getElementById('send-btn');
    
    // Reset mic button
    micButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic">
            <path d="M12 19v3"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><rect x="9" y="2" width="6" height="13" rx="3"/>
        </svg>
    `;
    
    // Remove audio feedback and show textarea
    removeAudioFeedback();
    textarea.style.display = 'block';
    
    // Reset send button
    if (textarea.value.trim() !== '') {
        sendBtn.style.cursor = 'pointer';
        sendBtn.style.opacity = '1';
    } else {
        sendBtn.style.cursor = 'not-allowed';
        sendBtn.style.opacity = '0.7';
    }
    
    isRecording = false;
}




   function scrollToBottom(){

    const messageArea = document.getElementById('messageArea');
       console.log(messageArea)
    if (messageArea) {

        console.log('scroll')

messageArea.lastElementChild.scrollIntoView({ behavior: "smooth" });    
    }

   }
   // Handle textarea input to enable/disable send button

   function checkInputValue() {
     const textarea = document.getElementById('fn__chat_textarea');
     const sendBtn = document.getElementById('send-btn');
     if (textarea.value.trim() !== '') {
       // Add active styling
       sendBtn.style.cursor = 'pointer';
     } else {
       // Revert to default
       sendBtn.style.cursor = 'not-allowed';
     }
   }

  // document.getElementById('fn__chat_textarea').addEventListener('input', function() {
    // document.getElementById('fn__chat_button').disabled = this.value.trim() === '';
   //});
   // Handle Enter key press
   function handleKeyPress(event) {
     if (event.key === 'Enter' && document.getElementById('fn__chat_textarea').value.trim() !== '') {
       sendMessage();
     }
   }

   // Send message function
   function sendMessage() {
     const textarea = document.getElementById('fn__chat_textarea');
     const message = textarea.value.trim();

       textarea.value = '';
     if (!message) return;

     fetch('{{settings['backend_url']}}/min/chat/{{chat.chat_id}}/send_message', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/x-www-form-urlencoded',
       },
       body: new URLSearchParams({
         message: message
       }),
       credentials: 'include'
     })
     .then(response => {
       if (!response.ok) {
         throw new Error('Network response was not ok');
       }
       scrollToBottom();
     })
     .catch(error => {

       textarea.value = message;
       console.error('Error sending message:', error);
     });
   }

   // Ping admin function
   function pingAdmin() {
       console.log('ping')
     fetch('{{settings['backend_url']}}/min/chat/{{chat.chat_id}}/ping_admin', {
       method: 'POST',
       credentials: 'include'
     })
     .then(response => {
       if (!response.ok) {
         throw new Error('Failed to ping admin');
       }
     })
     .catch(error => {
       console.error('Error pinging admin:', error);
     });
   }

   {% if chat %}
   function initChat() {
     // Function to fix all links in HTML content
     function fixAllLinks(element) {
       const links = element.querySelectorAll('a');

       links.forEach(link => {
         // Add target="_blank" to open in new tab
         link.setAttribute('target', '_blank');
         link.setAttribute('rel', 'noopener noreferrer');

         // Fix URLs without http/https
         let href = link.getAttribute('href');
         if (href && !/^https?:\/\//i.test(href)) {
           link.setAttribute('href', 'https://' + href);
         }
       });


     }

     // Apply to existing .md-content elements
     <!-- document.querySelectorAll('.md-content').forEach(el => { -->
     <!--   // Parse markdown -->
     <!--   el.innerHTML = marked.parse(el.textContent); -->
     <!---->
     <!--   // Fix links -->
     <!--   fixAllLinks(el); -->
     <!-- }); -->

     // Socket.io connection
     const roomId = "{{chat.room_id}}";

     const socket = io('{{settings["backend_url"]}}', {withCredentials: true});

     socket.on('connect', function() {
       socket.emit('join_min', {room: roomId});
     });

     socket.on('new_message', function(data) {
         console.log("new_message")

       appendMessage(data);
     });
   }

function appendMessage(message) {
  const messagesContainer = document.getElementById('messageArea');

  // Create a temporary div for processing
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = marked.parse(message.content);
  console.log(message)

  // Fix links in the rendered content
  fixAllLinks(tempDiv);
  console.log(tempDiv)
  
  if(message.sender !== '{{username}}'){
    const audio = new Audio("{{settings["backend_url"]}}/static/sounds/message.wav");
    audio.play();
  }
  
  const username = '{{username}}'

  const messageHTML = `
    <div 
      style="
        position: relative;
        width: fit-content;
        max-width: 85%;
        align-self:${message.sender === '{{username}}' ? 'flex-end' : 'flex-start'};
        display: flex;
        flex-direction: row;
        gap: 10px;
        align-items: flex-start;
      "
    >
      ${message.sender === "bot" ? `
        <div style="width: 40px; height: 40px; flex-shrink: 0;">
          <!-- Bot Avatar SVG -->
          <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"> 
            <!-- Your SVG content here -->
          </svg>
        </div>
      ` : ""}

      <div 
        class="md-content"
        style="
          padding: 10px;
          border-radius: 5px;
          font-size: 12px;
          font-weight: 400;
          font-family: var(--goglobe-heading-font-family);
          background-color: ${message.sender === username ? '#cfcbe0' : 'var(--goglobe-some-r-bg-color)'};
          color: var(--goglobe-heading-color);
          border: 0.5px solid var(--goglobe-border-color);
          width: 85%;
          word-wrap: break-word;
          overflow-wrap: break-word;
        "
      >
        ${message.type === 'audio'
          ? `
            <audio controls style="width: 100%;" ${message.sender !== username ? 'class="auto-play-audio"' : ''}>
              <source 
                src="{{settings["backend_url"]}}/min/chat/{{chat.room_id}}/audio_file/${message.id}" 
                type="audio/wav"
              />
              Your browser does not support the audio element.
            </audio>
            ${message.content 
              ? `<div 
                  style="
                    font-size: 12px;
                    color: var(--goglobe-heading-color);
                    margin-top: 4px;
                    font-style: italic;
                  ">
                  ${message.content}
                </div>`
              : ''}
          `
          : `${tempDiv.innerHTML}`
        }
      </div>
    </div>
  `;

  messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
  
  // Auto-play the last audio message if it's from someone else
  if (message.type === 'audio' && message.sender !== username) {
    // Wait for the DOM to be updated, then find and play the last audio element
    setTimeout(() => {
      const audioElements = messagesContainer.querySelectorAll('audio.auto-play-audio');
      if (audioElements.length > 0) {
        const lastAudio = audioElements[audioElements.length - 1];
        
        // Stop any currently playing audio
        audioElements.forEach(audio => {
          if (audio !== lastAudio && !audio.paused) {
            audio.pause();
            audio.currentTime = 0;
          }
        });
        
        // Play the last audio
        lastAudio.play().catch(error => {
          console.log('Autoplay prevented or audio error:', error);
        });
      }
    }, 100);
  }
  
  scrollToBottom();
}

   // Function to fix all links in HTML content
   function fixAllLinks(element) {
     const links = element.querySelectorAll('a');

     links.forEach(link => {
       // Add target="_blank" to open in new tab
       link.setAttribute('target', '_blank');
       link.setAttribute('rel', 'noopener noreferrer');

       // Fix URLs without http/https
       let href = link.getAttribute('href');
       if (href && !/^https?:\/\//i.test(href)) {
         link.setAttribute('href', 'https://' + href);
       }
     });
   }
   {% endif %}
</script>

{% if chat %}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
 
function showReturnChatButton() {
console.log("return ")
    let returnButton = document.getElementById('return-chat');
    if (returnButton) {
        returnButton.style.display = 'block';
        
        // Make sure HTMX processes the button
        if (typeof htmx !== 'undefined') {
            htmx.process(returnButton);
        }
    }
}

showReturnChatButton()

    // Initialize chat when the page loads
  initChat();

scrollToBottom();

</script>
{% endif %}
{% endblock %}
