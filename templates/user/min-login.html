{% extends 'user/base-min.html' %} {% block content %}
<!-- Sign In -->
<style>
  /* Simple styling for form validation */
  input:invalid, select:invalid {
    border-color: #ef4444;
  }
  input::placeholder{
    color:gray;
  }
  
  /* Error message styling */
  .error-text {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 20px;
    margin-bottom: 10px;
    border-radius: 6px;
    position: relative;
  }
  
  
  .input-error {
    border: 1px solid #ef4444 !important;
    box-shadow: 0 0 0 1px #ef4444 !important;
  }

  /* Phone input container styling */
  .phone-input-container {
    display: flex;
    align-items: center;
    border: 1px solid var(--goglobe-site-bg-color);
    border-radius: 6px;
    background-color: var(--goglobe-input-color);
    transition: all 0.2s;
    overflow: hidden;
  }

  .phone-input-container:focus-within {
    border-color: var(--goglobe-main-color);
  }
</style>


<div style="display:flex;flex-direction:column;">
<div style="display:flex; flex-direction:row;gap:15px; margin-bottom:20px;">
<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M36.8532 22.8708C38.5603 13.7173 32.3861 4.88706 23.0631 3.14835C13.7402 1.40964 4.79815 7.42077 3.09105 16.5742C1.38396 25.7276 7.55813 34.5579 16.8811 36.2966L33.3017 39.359L31.0172 32.7057C34.0749 30.2049 36.1394 26.7257 36.8532 22.8708Z" fill="white"/> <path d="M10.5771 19.1575V28.7471H29.4963L29.4088 19.1575L28.5054 14.5017L12.1753 15.4051L10.5771 19.1575Z" fill="#F7D5B1"/> <path d="M6.54663 11.4439L10.577 19.1572L12.1753 15.4048L28.5053 14.5014L29.4087 19.1572L31.4239 12.2083L27.0461 11.3049L28.4359 9.08122L26.0385 9.39392L28.4706 6.05842L23.4674 8.35158L25.8995 3.4873L18.5336 8.14311L17.8387 6.1974L6.54663 11.4439Z" fill="#52504D"/> <path d="M10.5947 28.6041V32.6335H29.2158V28.5854L10.5947 28.6041Z" fill="white"/> <path d="M12.5228 28.6772L20.0277 36.1821L27.4631 28.6772H12.5228Z" fill="#E8EAEB"/> <path d="M13.0092 28.6772L15.7193 31.8738L19.9581 28.7467L24.2665 31.8738L26.9766 28.6772H13.0092Z" fill="white"/> <path d="M19.9582 28.7468L18.4989 29.7892V30.1366H21.5564V29.7892L19.9582 28.7468Z" fill="#C95C1C"/> <path d="M19.9052 35.872H22.334L21.5564 30.1367H18.4989L17.8812 35.872H19.9052Z" fill="#FF5E00"/> <path d="M20.1363 25.5851C21.5526 25.5851 22.8934 24.1464 22.7509 23.5381C22.6085 22.9299 21.5526 23.5381 20.1363 23.5381C18.7201 23.5381 17.6935 22.8278 17.6223 23.5381C17.5511 24.2485 18.6908 25.4829 20.1363 25.5851Z" fill="#3B3731"/> <path d="M14.631 19.9912C15.0916 19.9912 15.4649 19.6179 15.4649 19.1574C15.4649 18.6968 15.0916 18.3235 14.631 18.3235C14.1705 18.3235 13.7971 18.6968 13.7971 19.1574C13.7971 19.6179 14.1705 19.9912 14.631 19.9912Z" fill="#3B3731"/> <path d="M25.2631 19.9912C25.7236 19.9912 26.097 19.6179 26.097 19.1574C26.097 18.6968 25.7236 18.3235 25.2631 18.3235C24.8026 18.3235 24.4292 18.6968 24.4292 19.1574C24.4292 19.6179 24.8026 19.9912 25.2631 19.9912Z" fill="#3B3731"/> <path d="M10.5771 19.1575V28.7471H29.4963L29.4088 19.1575L28.5054 14.5017L12.1753 15.4051L10.5771 19.1575Z" fill="#F7D5B1"/> <path d="M6.54663 11.4439L10.577 19.1572L12.1753 15.4048L28.5053 14.5014L29.4087 19.1572L31.4239 12.2083L27.0461 11.3049L28.4359 9.08122L26.0385 9.39392L28.4706 6.05842L23.4674 8.35158L25.8995 3.4873L18.5336 8.14311L17.8387 6.1974L6.54663 11.4439Z" fill="#52504D"/> <path d="M10.5947 28.6041V32.6335H29.2158V28.5854L10.5947 28.6041Z" fill="white"/> <path d="M12.5228 28.6772L20.0277 36.1821L27.4631 28.6772H12.5228Z" fill="#E8EAEB"/> <path d="M13.0092 28.6772L15.7193 31.8738L19.9581 28.7467L24.2665 31.8738L26.9766 28.6772H13.0092Z" fill="white"/> <path d="M19.9582 28.7468L18.4989 29.7892V30.1366H21.5564V29.7892L19.9582 28.7468Z" fill="#C95C1C"/> <path d="M19.9052 35.872H22.334L21.5564 30.1367H18.4989L17.8812 35.872H19.9052Z" fill="#FF5E00"/> <path d="M20.1363 25.5851C21.5526 25.5851 22.8934 24.1464 22.7509 23.5381C22.6085 22.9299 21.5526 23.5381 20.1363 23.5381C18.7201 23.5381 17.6935 22.8278 17.6223 23.5381C17.5511 24.2485 18.6908 25.4829 20.1363 25.5851Z" fill="#3B3731"/> <path d="M14.631 19.9912C15.0916 19.9912 15.4649 19.6179 15.4649 19.1574C15.4649 18.6968 15.0916 18.3235 14.631 18.3235C14.1705 18.3235 13.7971 18.6968 13.7971 19.1574C13.7971 19.6179 14.1705 19.9912 14.631 19.9912Z" fill="#3B3731"/> <path d="M25.2631 19.9912C25.7236 19.9912 26.097 19.6179 26.097 19.1574C26.097 18.6968 25.7236 18.3235 25.2631 18.3235C24.8026 18.3235 24.4292 18.6968 24.4292 19.1574C24.4292 19.6179 24.8026 19.9912 25.2631 19.9912Z" fill="#3B3731"/> </svg>

    <p style="color: #0e1024; font-size: 16px; font-style: normal; font-weight: 400; line-height: 20px; letter-spacing: -0.32px;">
        Let us know about you!
    </p>
</div>

<div style="overflow-y:hidden; background-color: var(--goglobe-site-bg-color); color: var(--goglobe-body-color); font-family: var(--goglobe-body-font-family); width: 100%;">
    <!-- Desktop logo would go here -->
    <div style="border-radius: 0.5rem; padding: 0.5rem; margin: 0 auto;">
        <div style="margin-bottom: 2rem;">
            <form id="login-form" novalidate>
 <div style="margin-bottom: 1rem; width: 100%;">
    <input type="text"
        style="font-family: var(--goglobe-body-font-family); width: 100%; border-radius: 6px; outline: none; border: 1px solid var(--goglobe-site-bg-color); padding: 12px; color: var( --goglobe-hover-color); font-weight: bold; transition: all 0.2s; background-color: var(--goglobe-input-color); box-sizing: border-box;"
        class='placeholder-[var(--goglobe-body-color)] placeholder-bold'
        id="name" name="name" placeholder="Your Name*" autocapitalize="off"
        autocomplete="name" required minlength="2"
        onfocus="this.style.border = '1px solid var(--goglobe-main-color)';"
        onblur="this.style.border = '1px solid var(--goglobe-site-bg-color)';">
</div>

<div style="margin-bottom: 1rem; width: 100%;">
    <input type="text"
        style="font-family: var(--goglobe-body-font-family); width: 100%; border-radius: 6px; outline: none; border: 1px solid var(--goglobe-site-bg-color); padding: 12px; color: var( --goglobe-hover-color); font-weight: bold; transition: all 0.2s; background-color: var(--goglobe-input-color); box-sizing: border-box;"
        class='placeholder-[var(--goglobe-body-color)] placeholder-bold'
        id="email" name="email" placeholder="Qatar ID*" autocapitalize="off"
        autocomplete="off" required pattern="[0-9]{11}"
        onfocus="this.style.border = '1px solid var(--goglobe-main-color)';"
        onblur="this.style.border = '1px solid var(--goglobe-site-bg-color)';">
</div>

                <button type="submit" id="login-btn"
                    style=" box-sizing: border-box;font-family: var(--goglobe-body-font-family); font-weight:bold; color:white; padding: 0.75rem 1rem; background-color: var(--goglobe-main-color); border: 1px solid var(--goglobe-border-color); border-radius: 6px; transition: all 0.2s;"
                    onmouseover="this.style.opacity=0.7; this.style.cursor='pointer'"
                    onmouseout="this.style.opacity=1; this.style.cursor='auto'"
                    onmousedown="this.style.backgroundColor='var(--goglobe-site-bg)'"
                    onmouseup="this.style.backgroundColor='var(--goglobe-site-bg)'"
                    >
                    Start Chat
                </button>

                <!-- Single Error Message Display -->
                <div id="error-message" class="error-text" style="display:none;"></div>
            </form>
        </div>
    </div>
</div>

</div>
<!-- !Sign In -->
{% endblock %}

{% block scripts %}
<script>
// Country data with flags, codes, and names

function initForm() {
    let loginForm = document.getElementById("login-form");
    let nameInput = document.getElementById("name");
    let qatarIdInput = document.getElementById("email");
    let errorMessage = document.getElementById("error-message");

    // Validation regex for Qatar ID (11 digits)
    let qatarIdRegex = /^[0-9]{11}$/;

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
    }

    function hideError() {
        errorMessage.textContent = "";
        errorMessage.style.display = "none";
    }

    function clearErrorStyling() {
        nameInput.classList.remove("input-error");
        qatarIdInput.classList.remove("input-error");
    }

    function validateForm() {
        hideError();
        clearErrorStyling();

        // Validate name
        if (!nameInput.value.trim()) {
            nameInput.classList.add("input-error");
            showError("Name is required");
            return false;
        }
        if (nameInput.value.trim().length < 2) {
            nameInput.classList.add("input-error");
            showError("Name must be at least 2 characters");
            return false;
        }

        // Validate Qatar ID
        if (!qatarIdInput.value.trim()) {
            qatarIdInput.classList.add("input-error");
            showError("Qatar ID is required");
            return false;
        }
        if (!qatarIdRegex.test(qatarIdInput.value.trim())) {
            qatarIdInput.classList.add("input-error");
            showError("Qatar ID must be exactly 11 digits");
            return false;
        }

        return true;
    }

    // Form submission
    loginForm.addEventListener("submit", function (e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        let name = nameInput.value.trim();
        let qatarId = qatarIdInput.value.trim();
        let isHtmxRequest = document.getElementById("chatbox") !== null;
        
        fetch("{{settings['backend_url']}}/min/auth", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "HX-Request": isHtmxRequest
            },
            credentials: "include",
            body: JSON.stringify({
                name: name,
                email: qatarId
            }),
        })
        .then(async (response) => {
            if (!response.ok) {
                let data = await response.json();
                showError(data.error || "Login failed");
                return;
            }

            if (isHtmxRequest) {
                let text = await response.text();
                htmx.swap('#chatbox', text, {swapStyle: 'innerHTML'});
            } else {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    let text = await response.text();
                }
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            showError("An error occurred. Please try again.");
        });
    });

    // Real-time validation clearing
    [nameInput, qatarIdInput].forEach(input => {
        input.addEventListener("input", function () {
            hideError();
            clearErrorStyling();
        });
    });
}


// Initialize the form when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    initForm();
});

// Also call it immediately in case the script loads after DOM is ready
initForm();
</script>
{% endblock %}
