{% extends 'admin/base.html' %}
{% block header %}
{{super()}}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% set title = "Calls" %} 
{% block content %}
<style>
.call-list-scroll::-webkit-scrollbar {
    width: 6px;
}

.call-list-scroll::-webkit-scrollbar-track {
    background: transparent;
}

.call-list-scroll::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 3px;
}

.call-detail-scroll::-webkit-scrollbar {
    width: 6px;
}

.call-detail-scroll::-webkit-scrollbar-track {
    background: transparent;
}

.call-detail-scroll::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 3px;
}
</style>



<style>
#operator-status-widget {
    z-index: 9999;
    max-width: 350px;
}

#operator-status-widget.minimized #widget-content {
    display: none;
}

#operator-status-widget.minimized {
    min-width: auto;
}

@keyframes pulse-ring {
    0% {
        transform: scale(0.33);
    }
    80%, 100% {
        opacity: 0;
    }
}

#status-pulse.active {
    animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
}

/* Status dot colors */
.status-idle #status-dot { background-color: #9CA3AF; }
.status-idle #status-pulse { background-color: #9CA3AF; }

.status-connecting #status-dot { background-color: #F59E0B; }
.status-connecting #status-pulse { background-color: #F59E0B; }

.status-connected #status-dot { background-color: #10B981; }
.status-connected #status-pulse { background-color: #10B981; }

.status-incoming #status-dot { background-color: #3B82F6; }
.status-incoming #status-pulse { background-color: #3B82F6; }

.status-error #status-dot { background-color: #EF4444; }
.status-error #status-pulse { background-color: #EF4444; }

/* Quality bars animation */
.quality-excellent .quality-bar:nth-child(1),
.quality-excellent .quality-bar:nth-child(2),
.quality-excellent .quality-bar:nth-child(3),
.quality-excellent .quality-bar:nth-child(4) {
    background-color: #10B981;
}

.quality-good .quality-bar:nth-child(1),
.quality-good .quality-bar:nth-child(2),
.quality-good .quality-bar:nth-child(3) {
    background-color: #10B981;
}

.quality-fair .quality-bar:nth-child(1),
.quality-fair .quality-bar:nth-child(2) {
    background-color: #F59E0B;
}

.quality-poor .quality-bar:nth-child(1) {
    background-color: #EF4444;
}
</style>


<div class="flex flex-col w-full h-full items-center justify-center">
    <div class="flex flex-row w-full min-h-[80vh]">
        <!-- Call List Section -->
        <div class="flex flex-col gap-[25px] {% if call %}w-1/3 min-w-[400px]{% else %}w-full{% endif %} h-[93vh] overflow-y-scroll call-list-scroll transition-all duration-300">
            <div class="flex flex-row gap-[32px] items-start justify-between mx-[24px] mt-[24px]">
                <p class="text-[18px] md:text-[26px] text-[var(--sec-text)]">Calls</p>
                
                <!-- Dropdown Filter -->
                <div class="relative" id="call-dropdown">
                    <button 
                        id="dropdown-button"
                        class="flex items-center justify-between px-[18px] py-[8px] bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-md text-[14px] font-bold hover:cursor-pointer min-w-[150px]"
                        onclick="toggleDropdown()"
                    >
                        <span id="selected-option">All Calls <span id="selected-count">({{ call_counts.all or calls|length }})</span></span>
                        <svg class="w-4 h-4 ml-2 transition-transform duration-200" id="dropdown-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div 
                        id="dropdown-menu"
                        class="absolute top-full left-0 mt-1 w-max bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-md shadow-lg z-50 hidden"
                    >
                        <div 
                            hx-get="/admin/calls/all?page=0"
                            hx-target="#call_list_container"
                            hx-trigger="click"
                            hx-on:click="selectOption(this, 'All Calls', '{{ call_counts.all or calls|length }}')"
                            hx-indicator="#loading-indicator"
                            class="dropdown-option px-[18px] py-[8px] text-[14px] hover:bg-[var(--border-color)] cursor-pointer flex flex-row gap-2 flex-nowrap justify-between"
                            data-value="all"
                        >
                            All Calls <span class="float-right">({{ call_counts.all or calls|length }})</span>
                        </div>
                        
                        <div 
                            hx-get="/admin/calls/ongoing?page=0"
                            hx-target="#call_list_container"
                            hx-trigger="click"
                            hx-on:click="selectOption(this, 'Ongoing Calls', '{{ call_counts.ongoing or 0 }}')"
                            hx-indicator="#loading-indicator"
                            class="dropdown-option px-[18px] py-[8px] text-[14px] hover:bg-[var(--border-color)] cursor-pointer flex flex-row gap-2 flex-nowrap justify-between"
                            data-value="ongoing"
                        >
                            Ongoing Calls <span class="float-right">({{ call_counts.ongoing or 0 }})</span>
                        </div>
                        
                        <div 
                            hx-get="/admin/calls/ended?page=0"
                            hx-target="#call_list_container"
                            hx-trigger="click"
                            hx-on:click="selectOption(this, 'Ended Calls', '{{ call_counts.ended or 0 }}')"
                            hx-indicator="#loading-indicator"
                            class="dropdown-option px-[18px] py-[8px] text-[14px] hover:bg-[var(--border-color)] cursor-pointer flex flex-row gap-2 flex-nowrap justify-between"
                            data-value="ended"
                        >
                            Ended Calls <span class="float-right">({{ call_counts.ended or 0 }})</span>
                        </div>
                        
                        <div 
                            hx-get="/admin/calls/in_progress?page=0"
                            hx-target="#call_list_container"
                            hx-trigger="click"
                            hx-on:click="selectOption(this, 'In Progress Calls', '{{ call_counts.in_progress or 0 }}')"
                            hx-indicator="#loading-indicator"
                            class="dropdown-option px-[18px] py-[8px] text-[14px] hover:bg-[var(--border-color)] cursor-pointer flex flex-row gap-2 flex-nowrap justify-between"
                            data-value="in_progress"
                        >
                            In Progress Calls <span class="float-right">({{ call_counts.in_progress or 0 }})</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col" id="call_list_container">
                {% include 'components/call-list.html' %}
            </div>
        </div>
        
        <!-- Call Detail Section -->
        {% include "components/call.html" %}
    </div>
    <!-- Operator Status Widget -->
<div id="operator-status-widget"
     class="fixed bottom-6 right-6 bg-[var(--sec-bg-color)] border-2 border-[var(--border-color)] rounded-2xl shadow-2xl overflow-hidden transition-all duration-300 hover:shadow-3xl">
    
    <!-- Header with status indicator -->
    <div class="bg-gradient-to-r from-[var(--border-color)] to-transparent p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div id="status-pulse" class="absolute inset-0 rounded-full animate-ping opacity-75 bg-gray-400"></div>
                <div id="status-dot" class="relative w-3 h-3 rounded-full bg-gray-400"></div>
            </div>
            <span class="font-semibold text-sm text-[var(--sec-text)]">Operator Status</span>
        </div>
        <button onclick="toggleWidgetMinimize()" class="text-[var(--sec-text)] hover:text-[var(--text-color)] transition">
            <svg id="minimize-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
    </div>
    
    <!-- Widget Content -->
    <div id="widget-content" class="p-4 min-w-[280px]">
        <!-- Current Status -->
        <div class="mb-4 p-3 rounded-lg bg-[var(--border-color)] bg-opacity-30">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-[var(--sec-text)] uppercase tracking-wide">Current Status</span>
                <span id="call-duration" class="text-xs text-[var(--sec-text)] font-mono hidden">00:00</span>
            </div>
            <p id="operator-status" class="text-base font-medium text-[var(--text-color)]">Stand By</p>
        </div>
        
        <!-- Active Conference Info -->
        <div id="active-conference-info" class="mb-4 p-3 rounded-lg bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-20 hidden">
            <div class="flex items-center gap-2 mb-2">
                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                </svg>
                <span class="text-xs text-blue-400 font-semibold">Active Conference</span>
            </div>
            <p id="conference-name" class="text-sm text-[var(--text-color)] font-mono truncate"></p>
        </div>
        
        <!-- Audio Controls -->
        <div id="audio-controls" class="mb-4 hidden">
            <div class="flex gap-2">
                <button id="muteBtn" 
                        onclick="toggleMute()"
                        class="flex-1 bg-[var(--border-color)] hover:bg-opacity-80 text-[var(--text-color)] px-3 py-2 rounded-lg text-xs font-medium transition flex items-center justify-center gap-2">
                    <svg id="mute-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                    <span id="mute-text">Mute</span>
                </button>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-2">
            <button id="acceptCallBtn"
                    onclick="acceptIncomingCall()"
                    class="hidden flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
                Accept
            </button>
            <button id="endCallBtn"
                    onclick="endCall()"
                    class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"/>
                </svg>
                End Call
            </button>
        </div>
        
        <!-- Connection Quality Indicator -->
        <div id="connection-quality" class="mt-3 pt-3 border-t border-[var(--border-color)] hidden">
            <div class="flex items-center justify-between">
                <span class="text-xs text-[var(--sec-text)]">Connection Quality:</span>
                <div class="flex gap-1" id="quality-bars">
                    <div class="w-1 h-3 bg-gray-400 rounded-full"></div>
                    <div class="w-1 h-4 bg-gray-400 rounded-full"></div>
                    <div class="w-1 h-5 bg-gray-400 rounded-full"></div>
                    <div class="w-1 h-6 bg-gray-400 rounded-full"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>


    <script src="/static/js/twilio.min.js"></script>

<script>
function toggleDropdown() {
    const dropdownMenu = document.getElementById('dropdown-menu');
    const dropdownIcon = document.getElementById('dropdown-icon');
    
    if (dropdownMenu.classList.contains('hidden')) {
        dropdownMenu.classList.remove('hidden');
        dropdownIcon.style.transform = 'rotate(180deg)';
    } else {
        dropdownMenu.classList.add('hidden');
        dropdownIcon.style.transform = 'rotate(0deg)';
    }
}

function selectOption(element, optionText, count) {
    const selectedOption = document.getElementById('selected-option');
    selectedOption.innerHTML = `${optionText} <span id="selected-count">(${count})</span>`;
    
    // Close dropdown
    document.getElementById('dropdown-menu').classList.add('hidden');
    document.getElementById('dropdown-icon').style.transform = 'rotate(0deg)';
    
    // Reset scroll position when switching options
    const callListContainer = document.getElementById('call_list_container');
    if (callListContainer) {
        callListContainer.scrollTop = 0;
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('call-dropdown');
    if (!dropdown.contains(event.target)) {
        document.getElementById('dropdown-menu').classList.add('hidden');
        document.getElementById('dropdown-icon').style.transform = 'rotate(0deg)';
    }
});

function updateCallCounts() {
    fetch('/admin/call-counts')
        .then(response => response.json())
        .then(data => {
            const selectedCount = document.getElementById('selected-count');
            const selectedOption = document.getElementById('selected-option').textContent;
            
            if (selectedOption.includes('All Calls')) {
                selectedCount.textContent = `(${data.all})`;
            } else if (selectedOption.includes('Ongoing Calls')) {
                selectedCount.textContent = `(${data.ongoing})`;
            } else if (selectedOption.includes('Ended Calls')) {
                selectedCount.textContent = `(${data.ended})`;
            } else if (selectedOption.includes('In Progress Calls')) {
                selectedCount.textContent = `(${data.in_progress})`;
            }
            
            const dropdownOptions = document.querySelectorAll('.dropdown-option');
            dropdownOptions.forEach(option => {
                const value = option.getAttribute('data-value');
                const countSpan = option.querySelector('span');
                if (countSpan) {
                    switch(value) {
                        case 'all':
                            countSpan.textContent = `(${data.all})`;
                            break;
                        case 'ongoing':
                            countSpan.textContent = `(${data.ongoing})`;
                            break;
                        case 'ended':
                            countSpan.textContent = `(${data.ended})`;
                            break;
                        case 'in_progress':
                            countSpan.textContent = `(${data.in_progress})`;
                            break;
                    }
                }
            });
        })
        .catch(error => console.error('Error updating call counts:', error));
}

let callDurationInterval = null;
let callStartTime = null;
let isMuted = false;
let isOnHold = false;

function toggleWidgetMinimize() {
    const widget = document.getElementById('operator-status-widget');
    const icon = document.getElementById('minimize-icon');
    
    widget.classList.toggle('minimized');
    
    if (widget.classList.contains('minimized')) {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>';
    } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
    }
}

function updateOperatorStatus(text, statusType = 'idle') {
    const el = document.getElementById("operator-status");
    const widget = document.getElementById("operator-status-widget");
    const endBtn = document.getElementById("endCallBtn");
    const acceptBtn = document.getElementById("acceptCallBtn");
    const audioControls = document.getElementById("audio-controls");
    const conferenceInfo = document.getElementById("active-conference-info");
    const connectionQuality = document.getElementById("connection-quality");
    const statusPulse = document.getElementById("status-pulse");
    
    if (el) el.textContent = text;
    
    // Remove all status classes
    widget.classList.remove('status-idle', 'status-connecting', 'status-connected', 'status-incoming', 'status-error');
    
    // Add appropriate status class
    widget.classList.add(`status-${statusType}`);
    
    // Show/hide pulse animation
    if (statusType === 'connected' || statusType === 'incoming' || statusType === 'connecting') {
        statusPulse.classList.add('active');
    } else {
        statusPulse.classList.remove('active');
    }
    
    // Handle button states and visibility
    if (statusType === 'incoming') {
        acceptBtn.classList.remove('hidden');
        endBtn.disabled = false;
        audioControls.classList.add('hidden');
        conferenceInfo.classList.add('hidden');
        stopCallDuration();
    } else if (statusType === 'connected') {
        acceptBtn.classList.add('hidden');
        endBtn.disabled = false;
        audioControls.classList.remove('hidden');
        conferenceInfo.classList.remove('hidden');
        connectionQuality.classList.remove('hidden');
        startCallDuration();
    } else if (statusType === 'connecting') {
        acceptBtn.classList.add('hidden');
        endBtn.disabled = false;
        audioControls.classList.add('hidden');
        conferenceInfo.classList.add('hidden');
        stopCallDuration();
    } else {
        acceptBtn.classList.add('hidden');
        endBtn.disabled = true;
        audioControls.classList.add('hidden');
        conferenceInfo.classList.add('hidden');
        connectionQuality.classList.add('hidden');
        stopCallDuration();
    }
}

function startCallDuration() {
    callStartTime = Date.now();
    const durationEl = document.getElementById('call-duration');
    durationEl.classList.remove('hidden');
    
    callDurationInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        durationEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
}

function stopCallDuration() {
    if (callDurationInterval) {
        clearInterval(callDurationInterval);
        callDurationInterval = null;
    }
    const durationEl = document.getElementById('call-duration');
    durationEl.classList.add('hidden');
    durationEl.textContent = '00:00';
}

function updateConferenceName(name) {
    const conferenceNameEl = document.getElementById('conference-name');
    if (conferenceNameEl) {
        conferenceNameEl.textContent = name || 'Unknown Conference';
    }
}

function toggleMute() {
    if (!activeCall) return;
    
    isMuted = !isMuted;
    activeCall.mute(isMuted);
    console.log(`Call Mute status: ${isMuted}`)
    
    const muteBtn = document.getElementById('muteBtn');
    const muteText = document.getElementById('mute-text');
    const muteIcon = document.getElementById('mute-icon');
    
    if (isMuted) {
        muteBtn.classList.remove('bg-[var(--border-color)]');
        muteBtn.classList.add('bg-red-500', 'text-white');
        muteText.textContent = 'Unmute';
        muteIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>';
    } else {
        muteBtn.classList.add('bg-[var(--border-color)]');
        muteBtn.classList.remove('bg-red-500', 'text-white');
        muteText.textContent = 'Mute';
        muteIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>';
    }
}


function acceptIncomingCall() {
    if (activeCall) {
        activeCall.accept();
    }
}

function updateConnectionQuality(quality) {
    const qualityBars = document.getElementById('quality-bars');
    if (!qualityBars) return;
    
    qualityBars.className = 'flex gap-1';
    
    if (quality >= 4) {
        qualityBars.classList.add('quality-excellent');
    } else if (quality >= 3) {
        qualityBars.classList.add('quality-good');
    } else if (quality >= 2) {
        qualityBars.classList.add('quality-fair');
    } else {
        qualityBars.classList.add('quality-poor');
    }
}

// Enhanced Twilio Device initialization
async function initOperatorDevice() {
    updateOperatorStatus("Initializing...", "connecting");
    try {
        const res = await fetch("/call/token?identity=operator");
        const data = await res.json();

        device = new Twilio.Device(data.token, {
            codecPreferences: ["opus", "pcmu"],
            enableRingingState: true
        });

        device.on("registered", () => updateOperatorStatus("Ready - Waiting for calls", "idle"));
        device.on("error", (err) => updateOperatorStatus(`Error: ${err.message}`, "error"));
        device.on("disconnect", () => {
            updateOperatorStatus("Ready - Waiting for calls", "idle");
            isMuted = false;
            isOnHold = false;
        });
        device.on("incoming", handleIncomingCall);

    } catch (e) {
        updateOperatorStatus("Initialization failed", "error");
        console.error("Twilio init error:", e);
    }
}

function handleIncomingCall(call) {
    console.log("Incoming call to operator:", call);
    activeCall = call;
    updateOperatorStatus("Incoming call...", "incoming");
    
    // Update conference name if available
    const params = call.customParameters;
    if (params && params.conferenceName) {
        updateConferenceName(params.conferenceName);
    }
}

async function initiateCall(conferenceName) {
    if (!device) {
        console.warn("Device not ready");
        return;
    }

          await device.register();

    updateOperatorStatus("Connecting...", "connecting");
    try {
        const call = await device.connect({ params: { To: conferenceName } });
        activeCall = call;
        updateConferenceName(conferenceName);
        updateOperatorStatus(`Connected`, "connected");
        
        // Simulate connection quality updates
        setInterval(() => {
            const quality = Math.floor(Math.random() * 2) + 3; // Random quality 3-4
            updateConnectionQuality(quality);
        }, 5000);
    } catch (e) {
        updateOperatorStatus("Connection failed", "error");
        console.error(e);
    }
}

function endCall() {
    if (activeCall) {
        activeCall.disconnect();
        activeCall = null;
    }
    isMuted = false;
    isOnHold = false;
    updateOperatorStatus("Ready - Waiting for calls", "idle");
    {% if call %}
        
    fetch(`{{backend_url}}/call/{{call.call_Id}}/end`, {
     method: "POST"})    {% endif %}

}

// Initialize when page loads
document.addEventListener("DOMContentLoaded", initOperatorDevice);
</script>




{% endblock %}
